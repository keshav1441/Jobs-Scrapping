<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Scraping Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .job-card {
            transition: transform 0.2s;
            border-left: 4px solid #007bff;
        }
        .job-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .filter-section {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .loading {
            display: none;
        }
        .job-title {
            color: #007bff;
            text-decoration: none;
        }
        .job-title:hover {
            color: #0056b3;
        }
        .source-badge {
            font-size: 0.8em;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-briefcase"></i> Job Scraping Dashboard
            </a>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <h3 id="total-jobs">-</h3>
                        <p class="mb-0">Total Jobs</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <h3 id="recent-jobs">-</h3>
                        <p class="mb-0">Recent Jobs (24h)</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <h3 id="total-sources">-</h3>
                        <p class="mb-0">Sources</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <h3 id="total-companies">-</h3>
                        <p class="mb-0">Companies</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filter-section">
            <div class="row">
                <div class="col-md-3">
                    <label for="search" class="form-label">Search</label>
                    <input type="text" class="form-control" id="search" placeholder="Job title or description">
                </div>
                <div class="col-md-2">
                    <label for="company" class="form-label">Company</label>
                    <select class="form-select" id="company">
                        <option value="">All Companies</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="location" class="form-label">Location</label>
                    <select class="form-select" id="location">
                        <option value="">All Locations</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="source" class="form-label">Source</label>
                    <select class="form-select" id="source">
                        <option value="">All Sources</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="per-page" class="form-label">Per Page</label>
                    <select class="form-select" id="per-page">
                        <option value="10">10</option>
                        <option value="20" selected>20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button class="btn btn-primary w-100" onclick="loadJobs()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div class="text-center loading" id="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading jobs...</p>
        </div>

        <!-- Jobs List -->
        <div id="jobs-container">
            <!-- Jobs will be loaded here -->
        </div>

        <!-- Pagination -->
        <nav aria-label="Jobs pagination" id="pagination-container">
            <!-- Pagination will be loaded here -->
        </nav>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPage = 1;
        let totalPages = 1;

        // Load initial data
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadCompanies();
            loadLocations();
            loadSources();
            loadJobs();
        });

        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                
                document.getElementById('total-jobs').textContent = stats.total_jobs;
                document.getElementById('recent-jobs').textContent = stats.recent_jobs;
                document.getElementById('total-sources').textContent = stats.sources.length;
                
                // Calculate total companies
                const companiesResponse = await fetch('/api/companies');
                const companies = await companiesResponse.json();
                document.getElementById('total-companies').textContent = companies.length;
                
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadCompanies() {
            try {
                const response = await fetch('/api/companies');
                const companies = await response.json();
                
                const select = document.getElementById('company');
                select.innerHTML = '<option value="">All Companies</option>';
                companies.forEach(company => {
                    const option = document.createElement('option');
                    option.value = company;
                    option.textContent = company;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading companies:', error);
            }
        }

        async function loadLocations() {
            try {
                const response = await fetch('/api/locations');
                const locations = await response.json();
                
                const select = document.getElementById('location');
                select.innerHTML = '<option value="">All Locations</option>';
                locations.forEach(location => {
                    const option = document.createElement('option');
                    option.value = location;
                    option.textContent = location;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading locations:', error);
            }
        }

        async function loadSources() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                
                const select = document.getElementById('source');
                select.innerHTML = '<option value="">All Sources</option>';
                stats.sources.forEach(source => {
                    const option = document.createElement('option');
                    option.value = source.name;
                    option.textContent = source.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading sources:', error);
            }
        }

        async function loadJobs(page = 1) {
            const loading = document.getElementById('loading');
            const container = document.getElementById('jobs-container');
            
            loading.style.display = 'block';
            container.innerHTML = '';
            
            try {
                const params = new URLSearchParams({
                    page: page,
                    per_page: document.getElementById('per-page').value,
                    search: document.getElementById('search').value,
                    company: document.getElementById('company').value,
                    location: document.getElementById('location').value,
                    source: document.getElementById('source').value
                });
                
                const response = await fetch(`/api/jobs?${params}`);
                const data = await response.json();
                
                if (data.jobs && data.jobs.length > 0) {
                    displayJobs(data.jobs);
                    displayPagination(data.page, data.pages);
                    currentPage = data.page;
                    totalPages = data.pages;
                } else {
                    container.innerHTML = '<div class="alert alert-info">No jobs found matching your criteria.</div>';
                }
                
            } catch (error) {
                console.error('Error loading jobs:', error);
                container.innerHTML = '<div class="alert alert-danger">Error loading jobs. Please try again.</div>';
            } finally {
                loading.style.display = 'none';
            }
        }

        function displayJobs(jobs) {
            const container = document.getElementById('jobs-container');
            
            jobs.forEach(job => {
                const jobCard = document.createElement('div');
                jobCard.className = 'card job-card mb-3';
                
                const datePosted = job.date_posted ? new Date(job.date_posted).toLocaleDateString() : 'N/A';
                const scrapedAt = job.scraped_at ? new Date(job.scraped_at).toLocaleDateString() : 'N/A';
                
                jobCard.innerHTML = `
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h5 class="card-title">
                                    ${job.apply_url ? `<a href="${job.apply_url}" target="_blank" class="job-title">${job.title}</a>` : job.title}
                                </h5>
                                <h6 class="card-subtitle mb-2 text-muted">
                                    <i class="fas fa-building"></i> ${job.company}
                                    ${job.location ? `<span class="ms-3"><i class="fas fa-map-marker-alt"></i> ${job.location}</span>` : ''}
                                </h6>
                                ${job.description ? `<p class="card-text">${job.description.substring(0, 200)}${job.description.length > 200 ? '...' : ''}</p>` : ''}
                            </div>
                            <div class="col-md-4 text-end">
                                <span class="badge bg-primary source-badge mb-2">${job.source_site}</span>
                                <br>
                                <small class="text-muted">
                                    <i class="fas fa-calendar"></i> Posted: ${datePosted}
                                    <br>
                                    <i class="fas fa-clock"></i> Scraped: ${scrapedAt}
                                </small>
                                ${job.salary ? `<br><small class="text-success"><i class="fas fa-dollar-sign"></i> ${job.salary}</small>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(jobCard);
            });
        }

        function displayPagination(currentPage, totalPages) {
            const container = document.getElementById('pagination-container');
            
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let paginationHTML = '<ul class="pagination justify-content-center">';
            
            // Previous button
            if (currentPage > 1) {
                paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadJobs(${currentPage - 1})">Previous</a></li>`;
            }
            
            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                const activeClass = i === currentPage ? 'active' : '';
                paginationHTML += `<li class="page-item ${activeClass}"><a class="page-link" href="#" onclick="loadJobs(${i})">${i}</a></li>`;
            }
            
            // Next button
            if (currentPage < totalPages) {
                paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadJobs(${currentPage + 1})">Next</a></li>`;
            }
            
            paginationHTML += '</ul>';
            container.innerHTML = paginationHTML;
        }

        // Add event listeners for filter changes
        document.getElementById('search').addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                loadJobs(1);
            }
        });

        ['company', 'location', 'source', 'per-page'].forEach(id => {
            document.getElementById(id).addEventListener('change', function() {
                loadJobs(1);
            });
        });
    </script>
</body>
</html>
